<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Liar</title>
    <link rel="manifest" href="manifest.json">
    <script>
      if('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        .container { max-width: 500px; width: 100%; background: #1e293b; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #94a3b8; font-size: 1.2em; text-transform: uppercase; margin-bottom: 10px; }
        #canvas-container { width: 100%; margin-top: 10px; background: #020617; border-radius: 8px; overflow: hidden; border: 1px solid #334155; display: none; }
        canvas { width: 100%; display: block; }
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        button { width: 100%; padding: 14px; background: #334155; color: #f8fafc; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .save-btn { background: #1e40af; }
        .dl-btn { background: #059669; }
        .status-box { margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 0.8em; text-align: center; font-weight: bold; background: #064e3b; color: #4ade80; border: 1px solid #22c55e; }
        .vault-item { background: #0f172a; padding: 8px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #10b981; font-size: 0.7em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project Liar</h1>
        
        <input type="file" id="fileInput" accept="image/*" style="font-size: 0.8em; color: #94a3b8;">
        
        <div id="canvas-container">
            <canvas id="editor"></canvas>
        </div>

        <div class="btn-group">
            <button onclick="processAndStamp()">Generate Witness Stamp</button>
            <button id="dlBtn" class="dl-btn" style="display:none;" onclick="downloadImage()">Download Stamped Clone</button>
            <button id="saveBtn" class="save-btn" style="display:none;" onclick="saveToVault()">Store in Vault</button>
        </div>

        <div id="verify-status" class="status-box" style="display:none;"></div>
        <div id="vault-list" style="margin-top: 20px;"></div>
    </div>

    <script>
        const canvas = document.getElementById('editor');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        let currentHash = "";
        let originalImg = null;
        let originalFileName = "evidence";

        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Capture the original name and remove the extension
            originalFileName = file.name.replace(/\.[^/.]+$/, "");
            
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImg = new Image();
                originalImg.onload = function() {
                    document.getElementById('canvas-container').style.display = 'block';
                    canvas.width = originalImg.width;
                    canvas.height = originalImg.height;
                    ctx.drawImage(originalImg, 0, 0);
                }
                originalImg.src = event.target.result;
            }
            reader.readAsDataURL(file);
        };

        async function processAndStamp() {
            if(!originalImg) return;
            
            const response = await fetch(originalImg.src);
            const blob = await response.blob();
            const arrayBuffer = await blob.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            currentHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            const ts = new Date().toLocaleString();

            ctx.drawImage(originalImg, 0, 0);
            
            // Visual Stamp Background
            const barHeight = canvas.height * 0.12;
            ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
            ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
            
            // Text Styles
            ctx.fillStyle = "#10b981"; 
            const fontSize = Math.floor(canvas.height * 0.03);
            ctx.font = `bold ${fontSize}px Courier New`;
            
            ctx.fillText("PROJECT LIAR - WITNESS EVIDENCE", 20, canvas.height - (barHeight * 0.65));
            ctx.font = `${fontSize * 0.6}px Courier New`;
            ctx.fillText(`ORIGINAL HASH: ${currentHash}`, 20, canvas.height - (barHeight * 0.4));
            ctx.fillText(`TIMESTAMP: ${ts}`, 20, canvas.height - (barHeight * 0.15));

            document.getElementById('verify-status').style.display = 'block';
            document.getElementById('verify-status').innerText = "WITNESS STAMP APPLIED";
            document.getElementById('dlBtn').style.display = 'block';
            document.getElementById('saveBtn').style.display = 'block';
        }

        function downloadImage() {
            const link = document.createElement('a');
            // Adding the tag to the file name as requested
            link.download = `${originalFileName}_WITNESS_STAMPED.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function saveToVault() {
            const vault = JSON.parse(localStorage.getItem('liarVault') || '[]');
            vault.unshift({ hash: currentHash, time: new Date().toLocaleString(), name: originalFileName });
            localStorage.setItem('liarVault', JSON.stringify(vault.slice(0, 10)));
            renderVault();
        }

        function renderVault() {
            const vault = JSON.parse(localStorage.getItem('liarVault') || '[]');
            document.getElementById('vault-list').innerHTML = '<h1 style="font-size:0.8em;">STAMPED HISTORY</h1>' + 
                vault.map(item => `<div class="vault-item"><strong>${item.name}</strong><br>${item.time}<br><span style="color:#64748b; font-size:0.8em;">${item.hash.substring(0,32)}...</span></div>`).join('');
        }
        renderVault();
    </script>
</body>
</html>
